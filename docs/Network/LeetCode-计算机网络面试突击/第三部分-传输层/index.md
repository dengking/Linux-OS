# 第三部分：传输层

## TCP 流量控制与拥塞控制

### 流量控制

所谓**流量控制**就是让**发送方**的发送速率不要太快，让**接收方**来得及接收。如果接收方来不及接收发送方发送的数据，那么就会有分组丢失。在 TCP 中利用可变长的**滑动窗口机制**可以很方便的在 TCP 连接上实现对发送方的流量控制。主要的方式是接收方返回的 ACK 中会包含自己的接收窗口大小，以控制发送方此次发送的数据量大小（发送窗口大小）。

### 拥塞控制

在实际的网络通信系统中，除了发送方和接收方外，还有路由器，交换机等复杂的网络传输线路，此时就需要拥塞控制。拥塞控制是作用于网络的，它是防止过多的数据注入到网络中，避免出现网络负载过大的情况。常用的解决方法有：慢开始和拥塞避免、快重传和快恢复。





## TCP 拥塞控制采用的四种算法

### 慢开始

当**发送方**开始发送数据时，由于一开始不知道网络负荷情况，如果立即将大量的数据字节传输到网络中，那么就有可能引起**网络拥塞**。一个较好的方法是在一开始发送少量的数据先探测一下网络状况，即由小到大的增大发送窗口（拥塞窗口 `cwnd`）。慢开始的慢指的是初始时令 `cwnd`为 `1`，即一开始发送一个报文段。如果收到确认，则 `cwnd = 2`，之后每收到一个确认报文，就令 `cwnd = cwnd* 2`。

但是，为了防止拥塞窗口增长过大而引起网络拥塞，另外设置了一个慢开始门限 `ssthresh`。

① 当 `cwnd < ssthresh` 时，使用上述的慢开始算法；

② 当 `cwnd > ssthresh` 时，停止使用慢开始，转而使用拥塞避免算法；

③ 当 `cwnd == ssthresh` 时，两者均可。

### 拥塞避免

**拥塞控制**是为了让**拥塞窗口** `cwnd` 缓慢地增大，即每经过一个往返时间 RTT （往返时间定义为发送方发送数据到收到确认报文所经历的时间）就把发送方的 cwnd 值加 1，通过让 cwnd 线性增长，防止很快就遇到网络拥塞状态。

当网络拥塞发生时，让新的**慢开始门限值**变为发生拥塞时候的值的一半,并将拥塞窗口置为 1 ,然后再次重复两种算法（**慢开始**和**拥塞避免**）,这时一瞬间会将网络中的数据量大量降低。

### 快重传

快重传算法要求接收方每收到一个失序的报文就立即发送重复确认，而不要等到自己发送数据时才捎带进行确认，假定发送方发送了 Msg 1 ~ Msg 4 这 4 个报文，已知接收方收到了 Msg 1，Msg 3 和 Msg 4 报文，此时因为接收到收到了失序的数据包，按照快重传的约定，接收方应立即向发送方发送 Msg 1 的重复确认。 于是在接收方收到 Msg 4 报文的时候，向发送方发送的仍然是 Msg 1 的重复确认。这样，发送方就收到了 3 次 Msg 1 的重复确认，于是立即重传对方未收到的 Msg 报文。由于发送方尽早重传未被确认的报文段，因此，快重传算法可以提高网络的吞吐量。

