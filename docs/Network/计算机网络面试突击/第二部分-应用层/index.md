# 第二部分：应用层



## DNS 的作用和原理 ★★★★

### DNS

DNS（Domain Name System）是域名系统的英文缩写，是一种组织成域层次结构的计算机和网络服务命名系统，用于 TCP/IP 网络。

### DNS 的作用

通常我们有两种方式识别主机：通过主机名或者 IP 地址。人们喜欢便于记忆的主机名表示，而路由器则喜欢定长的、有着层次结构的 IP 地址。为了满足这些不同的偏好，我们就需要一种能够进行**主机名**到 **IP 地址**转换的目录服务，域名系统作为将域名和 IP 地址相互映射的一个**分布式数据库**，能够使人更方便地访问互联网。

### DNS 域名解析原理

DNS 采用了分布式的设计方案，其域名空间采用一种树形的层次结构：

![](1612458680-mTSUQn-DNS服务器的层次结构.png)

上图展示了 DNS 服务器的部分层次结构，从上到下依次为**根域名服务器**、**顶级域名服务器**和**权威域名服务器**。其实**根域名服务器**在因特网上有13个，大部分位于北美洲。第二层为**顶级域服务器**，这些服务器负责**顶级域名**（如 `com`、`org`、`net`、`edu`）和所有国家的顶级域名（如`uk`、`fr`、`ca` 和 `jp`）。在第三层为**权威 DNS 服务器**，因特网上具有公共可访问主机（例如 Web 服务器和邮件服务器）的每个组织机构必须提供公共可访问的 **DNS 记录**，这些记录由**组织机构**的**权威 DNS 服务器**负责保存，这些记录将这些主机的名称映射为 IP 地址。

> NOTE: 
>
> 上述"其实**根域名服务器**在因特网上有13个"在 zhihu [为什么域名根服务器只能有13台呢？](https://www.zhihu.com/question/22587247) 中对其中缘由进行了分析。

除此之外，还有一类重要的 DNS 服务器，叫做**本地 DNS 服务器**。**本地 DNS 服务器**严格来说不在 DNS 服务器的层次结构中，但它对 DNS 层次结构是很重要的。一般来说，每个**网络服务提供商（ISP）** 都有一台**本地 DNS 服务器**。当主机与某个 ISP 相连时，该 ISP 提供一台主机的 IP 地址，该主机具有一台或多台其**本地 DNS 服务器**的 IP 地址。主机的**本地 DNS 服务器**通常和主机距离较近，当主机发起 DNS 请求时，该请求被发送到本地 DNS 服务器，它起着代理的作用，并将该请求转发到 **DNS 服务器**层次结构中。

> NOTE: 
>
> 查询时，key是domain name

#### Example

我们以一个例子来了解 DNS 的工作原理，假设主机 A（IP 地址为 `abc.xyz.edu`） 想知道主机 B 的 IP 地址 （`def.mn.edu`），如下图所示，主机 A 首先向它的**本地 DNS 服务器**发送一个 DNS 查询报文。该查询报文含有被转换的主机名 `def.mn.edu`。本地 DNS 服务器将该报文转发到**根 DNS 服务器**，**根 DNS 服务器**注意到查询的 IP 地址前缀为 `edu` 后向**本地 DNS 服务器**返回负责 `edu` 的**顶级域名服务器**的 **IP 地址列表**。该**本地 DNS 服务器**则再次向这些 顶级域名服务器发送查询报文。该顶级域名服务器注意到 `mn.edu` 的前缀，并用**权威域名服务器**的 IP 地址进行响应。通常情况下，**顶级域名服务器**并不总是知道每台主机的**权威 DNS 服务器**的 IP 地址，而只知道中间的某个服务器，该**中间 DNS 服务器**依次能找到用于相应主机的 IP 地址，我们假设中间经历了权威服务器 ① 和 ②，最后找到了负责 `def.mn.edu` 的**权威 DNS 服务器** ③，之后，本地 DNS 服务器直接向该服务器发送查询报文从而获得主机 B 的IP 地址。

![](1612458718-QcTlwM-DNS.png)

在上图中，IP 地址的查询其实经历了两种查询方式，分别是**递归查询**和**迭代查询**。

拓展：域名解析查询的两种方式

递归查询：如果主机所询问的**本地域名服务器**不知道被查询域名的 IP 地址，那么本地域名服务器就以 DNS 客户端的身份，向其他根域名服务器继续发出查询请求报文，即替主机继续查询，而不是让主机自己进行下一步查询，如上图步骤（1）和（10）。
迭代查询：当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所要查询的 IP 地址，要么告诉本地服务器下一步应该找哪个域名服务器进行查询，然后让本地服务器进行后续的查询，如上图步骤（2）~（9）。

## DNS 为什么用 UDP ★★

> NOTE: 
>
> 其实是在比较TCP和UDP，其实是在进行tradeoff

更正确的答案是 DNS 既使用 TCP 又使用 UDP。

当进行区域传送（主域名服务器向辅助域名服务器传送变化的那部分数据）时会使用 TCP，因为数据同步传送的数据量比一个请求和应答的数据量要多，而 TCP 允许的报文长度更长，因此为了保证数据的正确性，会使用基于可靠连接的 TCP。

当客户端向 DNS 服务器查询域名 ( 域名解析) 的时候，一般返回的内容不会超过 UDP 报文的最大长度，即 512 字节。用 UDP 传输时，不需要经过 TCP 三次握手的过程，从而大大提高了响应速度，但这要求域名解析器和域名服务器都必须自己处理超时和重传从而保证可靠性。

> NOTE: 
>
> 域名查询，数据量小 "一般返回的内容不会超过 UDP 报文的最大长度"，对速度要求较高

## 怎么实现 DNS 劫持 ★★★

**DNS 劫持**即**域名劫持**，是通过将原域名对应的 IP 地址进行替换从而使得用户访问到错误的网站或者使得用户无法正常访问网站的一种攻击方式。域名劫持往往只能在特定的网络范围内进行，范围外的 **DNS 服务器**能够返回正常的 IP 地址。攻击者可以冒充原域名所属机构，通过电子邮件的方式修改组织机构的**域名注册信息**，或者将域名转让给其它组织，并将新的域名信息保存在所指定的 **DNS 服务器**中，从而使得用户无法通过对原域名进行解析来访问目的网址。

> NOTE: 
>
> 这种在源头进行篡改的方式，在现实世界中，发生的可能性并不大。

具体实施步骤如下：

① 获取要劫持的域名信息：攻击者首先会访问域名查询站点查询要劫持的域名信息。

② 控制域名相应的 E-MAIL 账号：在获取到域名信息后，攻击者通过暴力破解或者专门的方法破解公司注册域名时使用的 E-mail 账号所对应的密码。更高级的攻击者甚至能够直接对 E-mail 进行信息窃取。

③ 修改注册信息：当攻击者破解了 E-MAIL 后，会利用相关的更改功能修改该域名的注册信息，包括域名拥有者信息，DNS 服务器信息等。

④ 使用 E-MAIL 收发确认函：在修改完注册信息后，攻击者在 E-mail 真正拥有者之前收到修改域名注册信息的相关确认信息，并回复确认修改文件，待网络公司恢复已成功修改信件后，攻击者便成功完成 DNS 劫持。



用户端的一些预防手段：

1、直接通过 IP 地址访问网站，避开 DNS 劫持。

2、由于域名劫持往往只能在特定的网络范围内进行，因此一些高级用户可以通过网络设置让 DNS 指向正常的域名服务器以实现对目的网址的正常访问，例如将计算机首选 DNS 服务器的地址固定为 8.8.8.8。



## socket() 套接字有哪些 ★★★

套接字（Socket）是对网络中不同主机上的应用进程之间进行双向通信的端点的抽象，网络进程通信的一端就是一个套接字，不同主机上的进程便是通过套接字发送报文来进行通信。例如 TCP 用主机的 IP 地址 + 端口号作为 TCP 连接的端点，这个端点就叫做套接字。

套接字主要有以下三种类型：

1、流套接字（`SOCK_STREAM`）：流套接字基于 TCP 传输协议，主要用于提供面向连接、可靠的数据传输服务。由于 TCP 协议的特点，使用流套接字进行通信时能够保证数据无差错、无重复传送，并按顺序接收，通信双方不需要在程序中进行相应的处理。

2、数据报套接字（`SOCK_DGRAM`）：和流套接字不同，数据报套接字基于 UDP 传输协议，对应于无连接的 UDP 服务应用。该服务并不能保证数据传输的可靠性，也无法保证对端能够顺序接收到数据。此外，通信两端不需建立长时间的连接关系，当 UDP 客户端发送一个数据给服务器后，其可以通过同一个套接字给另一个服务器发送数据。当用 UDP 套接字时，**丢包**等问题需要在程序中进行处理。

3、原始套接字（`SOCK_RAW`）：由于流套接字和数据报套接字只能读取 TCP 和 UDP 协议的数据，当需要传送非传输层数据包（例如 `Ping` 命令时用的 ICMP 协议数据包）或者遇到操作系统无法处理的数据包时，此时就需要建立原始套接字来发送。



## URI（统一资源标识符）和 URL（统一资源定位符）之间的区别 ★★★

URL，即统一资源定位符 (Uniform Resource Locator )，URL 其实就是我们平时上网时输入的网址，它标识一个互联网资源，并指定对其进行操作或获取该资源的方法。例如 https://leetcode-cn.com/problemset/all/ 这个 URL，标识一个特定资源并表示该资源的某种形式是可以通过 HTTP 协议从相应位置获得。

从定义即可看出，URL 是 URI 的一个子集，两者都定义了资源是什么，而 URL 还定义了如何能访问到该资源。URI 是一种语义上的抽象概念，可以是绝对的，也可以是相对的，而URL则必须提供足够的信息来定位，是绝对的。简单地说，只要能唯一标识资源的就是 URI，在 URI 的基础上给出其资源的访问方式的就是 URL。

> NOTE:
>
> URL是一种URI



## 为什么 fidder，charles 能抓到你的包【抓取数据包的过程】★★

假如我们需要抓取客户端的数据包，需要监控客户端与服务器交互之间的网络节点，监控其中任意一个网络节点（**网卡**），获取所有经过网卡中的数据，对这些数据按照网络协议进行解析，这就是抓包的基本原理。而中间的网络节点不受我们控制，是基本无法实现抓包的，因此只能在客户端与服务器之间进行抓包。

① 当采用抓包工具抓取 HTTP 数据包时，过程较为简单：

首先抓包工具会提出代理服务，客户端需要连接该代理；
客户端发出 HTTP 请求时，会经过抓包工具的代理，抓包工具将请求的原文进行展示；
抓包工具使用该原文将请求发送给服务器；
服务器返回结果给抓包工具，抓包工具将返回结果进行展示；
抓包工具将服务器返回的结果原样返回给客户端。
这里抓包工具相当于透明人，数据经过的时候它一只手接到数据，然后另一只手把数据传出去。

② 当抓取 HTTPS 数据包时：

客户端连接抓包工具提供的代理服务，并安装抓包工具的根证书；
客户端发出 HTTPS 请求，抓包工具模拟服务器与客户端进行 TLS 握手交换密钥等流程；
抓包工具发送一个 HTTPS 请求给客户端请求的目标服务器，并与目标服务器进行 TLS 握手交换密钥等流程；
客户端使用与抓包工具协定好的密钥加密数据后发送给抓包工具；
抓包工具使用与客户端协定好的密钥解密数据，并将结果进行展示；
抓包工具将解密后的客户端数据，使用与服务器协定好的密钥进行加密后发送给目标服务器；
服务器解密数据后，做对应的逻辑处理，然后将返回结果使用与抓包工具协定好的密钥进行加密发送给抓包工具；
抓包工具将服务器返回的结果，用与服务器协定好的密钥解密，并将结果进行展示；
抓包工具将解密后的服务器返回数据，使用与客户端协定好的密钥进行加密后发送给客户端；
客户端解密数据。
这个时候抓包工具对客户端来说相当于服务器，对服务器来说相当于客户端。在这个传输过程中，客户端会以为它就是目标服务器，服务器也会以为它就是请求发起的客户端。

## 如果你访问一个网站很慢，怎么排查和解决 ★★★

网页打开速度慢的原因有很多，这里列举出一些较常出现的问题：

① 首先最直接的方法是查看本地网络是否正常，可以通过**网络测速软件**例如电脑管家等对电脑进行测速，若网速正常，我们查看**网络带宽**是否被占用，例如当你正在下载电影时并且没有限速，是会影响你打开网页的速度的，这种情况往往是处理器内存小导致的；

② 当网速测试正常时，我们对**网站服务器速度**进行排查，通过 **ping** 命令查看链接到服务器的时间和丢包等情况，一个速度好的机房，首先丢包率不能超过 1%，其次 ping 值要小，最后是 ping 值要稳定，如最大和最小差值过大说明路由不稳定。或者我们也可以查看同台服务器上其他网站的打开速度，看是否其他网站打开也慢。

③ 如果网页打开的速度时快时慢，甚至有时候打不开，有可能是空间不稳定的原因。当确定是该问题时，就要找你的空间商解决或换空间商了，如果购买空间的话，可选择购买购买双线空间或多线空间；如果是在有的地方打开速度快，有的地方打开速度慢，那应该是网络线路的问题。电信线路用户访问放在联通服务器的网站，联通线路用户访问放在电信服务器上的网站，相对来说打开速度肯定是比较慢。

④ 从网站本身找原因。网站的问题主要包括网站程序设计、网页设计结构和网页内容三个部分。

1、网站程序设计：当访问网页中有拖慢网站打开速度的代码，会影响网页的打开速度，例如网页中的统计代码，我们最好将其放在网站的末尾。因此我们需要查看网页程序的设计结构是否合理；

2、网页设计结构：如果是 table 布局的网站，查看是否嵌套次数太多，或是一个大表格分成多个表格这样的网页布局，此时我们可以采用 div 布局并配合 css 进行优化。

3、网页内容：查看网页中是否有许多尺寸大的图片或者尺寸大的 flash 存在，我们可以通过降低图片质量，减小图片尺寸，少用大型 flash 加以解决。此外，有的网页可能过多地引用了其他网站的内容，若某些被引用的网站访问速度慢，或者一些页面已经不存在了，打开的速度也会变慢。一种直接的解决方法是去除不必要的加载项。

## 其他协议 ★

对于应用层来说，考察的重点集中在 HTTP 协议和 DNS 这两块，其他协议考察较少，我们仅加以了解即可。

### FTP

1、FTP（File Transfer Protocol，文件传输协议）是用于在网络上进行文件传输的一套标准协议，使用客户/服务器模式，使用 TCP 数据报，提供交互式访问，双向传输。

2、TFTP（Trivial File Transfer Protocol，简单文件传输协议）一个小且易实现的文件传输协议，也使用客户/服务器方式，使用 UDP 数据报，只支持文件传输而不支持交互，没有列目录，不能对用户进行身份鉴定。

### SMTP

SMTP（Simple Main Transfer Protocol，简单邮件传输协议）是在 Internet 传输 Email 的标准，是一个相对简单的基于文本的协议。在其之上指定了一条消息的一个或多个接收者（在大多数情况下被确认是存在的），然后消息文本会被传输。可以很简单地通过 Telnet 程序来测试一个 SMTP 服务器。SMTP 使用 TCP 端口 25。

### DHCP

DHCP ( Dynamic Host Configuration Protocol，动态主机设置协议 ) 是一个局域网的网络协议，使用 UDP 协议工作，主要有两个用途：

1、用于内部网络或网络服务供应商自动分配 IP 地址给用户

2、用于内部网络管理员作为对所有电脑作中央管理的手段

### SNMP

SNMP（Simple Network Management Protocol，简单网络管理协议）构成了互联网工程工作小组（IETF，Internet Engineering Task Force）定义的 Internet 协议族的一部分。该协议能够支持网络管理系统，用以监测连接到网络上的设备是否有任何引起管理上关注的情况。




## 网页解析全过程【用户输入网址到显示对应页面的全过程】★★★★★

![](1612459029-slhrTZ-页面显示流程图.png)

① DNS 解析：当用户输入一个网址并按下回车键的时候，浏览器获得一个域名，而在实际通信过程中，我们需要的是一个 IP 地址，因此我们需要先把**域名**转换成相应 **IP 地址**。【具体细节参看问题 16，17】

② TCP 连接：浏览器通过 DNS 获取到 **Web 服务器**真正的 **IP 地址**后，便向 **Web 服务器**发起 TCP 连接请求，通过 **TCP 三次握手**建立好连接后，浏览器便可以将 HTTP 请求数据发送给服务器了。【三次握手放在传输层详细讲解】

③ 发送 HTTP 请求：浏览器向 Web 服务器发起一个 HTTP 请求，**HTTP 协议**是建立在 **TCP 协议**之上的**应用层协议**，其本质是在建立起的**TCP连接**中，按照**HTTP协议**标准发送一个索要网页的请求。在这一过程中，会涉及到**负载均衡**等操作。

拓展：什么是负载均衡？

负载均衡，英文名为 **Load Balance**，其含义是指将负载（工作任务）进行平衡、分摊到多个操作单元上进行运行，例如 FTP 服务器、Web 服务器、企业核心服务器和其他主要任务服务器等，从而协同完成工作任务。负载均衡建立在现有的网络之上，它提供了一种透明且廉价有效的方法扩展服务器和网络设备的带宽、增加吞吐量、加强网络处理能力并提高网络的灵活性和可用性。

负载均衡是分布式系统架构设计中必须考虑的因素之一，例如天猫、京东等大型用户网站中为了处理海量用户发起的请求，其往往采用分布式服务器，并通过引入**反向代理**等方式将用户请求均匀分发到每个服务器上，而这一过程所实现的就是负载均衡。

④ 处理请求并返回：服务器获取到客户端的 HTTP 请求后，会根据 HTTP 请求中的内容来决定如何获取相应的文件，并将文件发送给浏览器。

⑤ 浏览器渲染：浏览器根据响应开始显示页面，首先解析 HTML 文件构建 DOM 树，然后解析 CSS 文件构建渲染树，等到渲染树构建完成后，浏览器开始布局渲染树并将其绘制到屏幕上。

⑥ 断开连接：客户端和服务器通过四次挥手终止 TCP 连接。【其中的细节放在传输层详细讲解】

